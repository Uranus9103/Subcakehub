--// SHIELD + MUSIC + FIRE + BACK SHIELD
-- LocalScript trong StarterPlayer > StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer

-- RemoteEvent cho Shield
local remote = ReplicatedStorage:FindFirstChild("ShieldToggleEvent")
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = "ShieldToggleEvent"
    remote.Parent = ReplicatedStorage
end

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PowerMenu"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 250)
frame.Position = UDim2.new(1, -210, 0, 20)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BackgroundTransparency = 0.3
frame.Parent = screenGui

-- Helper t·∫°o n√∫t
local function createButton(name, text, y)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -20, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, y)
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
    btn.Parent = frame
    btn.Name = name
    return btn
end

------------------------------------------------------
-- 1. Shield (quay quanh ng∆∞·ªùi)
------------------------------------------------------
local shieldBtn = createButton("ShieldBtn", "B·∫≠t L√° Ch·∫Øn Quanh Ng∆∞·ªùi", 10)
local numParts, radius, rotationSpeed, checkRadius = 6, 5, 2, 4
local activeShield = false
local orbitParts = {}

-- t·∫°o shield part
local function createParts()
    local parts = {}
    for i = 1, numParts do
        local part = Instance.new("Part")
        part.Size = Vector3.new(1.5,1.5,1.5)
        part.Shape = Enum.PartType.Ball
        part.Anchored = true
        part.CanCollide = false
        part.Material = Enum.Material.Neon
        part.Color = Color3.fromRGB(255, 170, 0)
        part.Parent = workspace
        table.insert(parts, part)
    end
    return parts
end

shieldBtn.MouseButton1Click:Connect(function()
    activeShield = not activeShield
    shieldBtn.Text = activeShield and "T·∫Øt L√° Ch·∫Øn Quanh Ng∆∞·ªùi" or "B·∫≠t L√° Ch·∫Øn Quanh Ng∆∞·ªùi"
    remote:FireServer("orbit", activeShield)
    if activeShield then
        orbitParts = createParts()
    else
        for _, p in pairs(orbitParts) do p:Destroy() end
        orbitParts = {}
    end
end)

RunService.RenderStepped:Connect(function()
    if not activeShield then return end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local time = tick() * rotationSpeed
    for i, part in ipairs(orbitParts) do
        local angle = time + (i * (2*math.pi/numParts))
        local x = hrp.Position.X + radius * math.cos(angle)
        local z = hrp.Position.Z + radius * math.sin(angle)
        part.Position = Vector3.new(x, hrp.Position.Y + 2, z)
    end
end)

------------------------------------------------------
-- 2. Music Player
------------------------------------------------------
local musicBox = Instance.new("TextBox")
musicBox.Size = UDim2.new(1, -20, 0, 30)
musicBox.Position = UDim2.new(0, 10, 0, 60)
musicBox.PlaceholderText = "Nh·∫≠p ID nh·∫°c..."
musicBox.Text = ""
musicBox.BackgroundColor3 = Color3.fromRGB(80,80,80)
musicBox.TextColor3 = Color3.new(1,1,1)
musicBox.Parent = frame

local musicBtn = createButton("MusicBtn", "Ph√°t Nh·∫°c", 100)

local currentSound
musicBtn.MouseButton1Click:Connect(function()
    local id = tonumber(musicBox.Text)
    if not id then return end
    if currentSound then currentSound:Destroy() end
    -- t·∫Øt nh·∫°c g·ªëc game
    for _, s in pairs(SoundService:GetDescendants()) do
        if s:IsA("Sound") then s.Playing = false end
    end
    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://"..id
    sound.Looped = true
    sound.Volume = 2
    sound.Parent = SoundService
    sound:Play()
    currentSound = sound
end)

------------------------------------------------------
-- 3. Back Shield (sau l∆∞ng)
------------------------------------------------------
local backShieldBtn = createButton("BackShieldBtn", "B·∫≠t L√° Ch·∫Øn Sau L∆∞ng", 150)
local backShieldActive = false
local backShieldPart

backShieldBtn.MouseButton1Click:Connect(function()
    backShieldActive = not backShieldActive
    backShieldBtn.Text = backShieldActive and "T·∫Øt L√° Ch·∫Øn Sau L∆∞ng" or "B·∫≠t L√° Ch·∫Øn Sau L∆∞ng"
    remote:FireServer("back", backShieldActive)

    if backShieldActive then
        local char = player.Character or player.CharacterAdded:Wait()
        local hrp = char:WaitForChild("HumanoidRootPart")
        backShieldPart = Instance.new("Part")
        backShieldPart.Size = Vector3.new(6,1,6)
        backShieldPart.Anchored = false
        backShieldPart.CanCollide = false
        backShieldPart.Transparency = 0.2
        backShieldPart.Material = Enum.Material.Neon
        backShieldPart.Color = Color3.fromRGB(0, 200, 255)
        backShieldPart.Parent = hrp

        local mesh = Instance.new("SpecialMesh")
        mesh.MeshType = Enum.MeshType.Torus
        mesh.Scale = Vector3.new(5,1,5)
        mesh.Parent = backShieldPart

        local weld = Instance.new("WeldConstraint")
        weld.Part0 = hrp
        weld.Part1 = backShieldPart
        weld.Parent = backShieldPart

        backShieldPart.CFrame = hrp.CFrame * CFrame.new(0,0,-4)
        RunService.RenderStepped:Connect(function()
            if backShieldPart and backShieldPart.Parent then
                backShieldPart.CFrame = hrp.CFrame * CFrame.new(0,0,-4) * CFrame.Angles(0, tick()*2, 0)
            end
        end)
    else
        if backShieldPart then backShieldPart:Destroy() backShieldPart=nil end
    end
end)

------------------------------------------------------
-- 4. Fire Effect
------------------------------------------------------
local fireBtn = createButton("FireBtn", "B·∫≠t L·ª≠a üî•", 200)
local fireActive = false
local fire

fireBtn.MouseButton1Click:Connect(function()
    fireActive = not fireActive
    fireBtn.Text = fireActive and "T·∫Øt L·ª≠a üî•" or "B·∫≠t L·ª≠a üî•"
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    if fireActive then
        fire = Instance.new("Fire")
        fire.Heat = 25
        fire.Size = 15
        fire.Parent = hrp
    else
        if fire then fire:Destroy() fire=nil end
    end
end)

------------------------------------------------------
-- SERVER DAMAGE HANDLER
------------------------------------------------------
remote.OnServerEvent:Connect(function(plr, shieldType, state)
    if shieldType == "orbit" then
        -- Damage b·∫±ng v√≤ng tr√≤n xoay quanh
        if state then
            local conn
            conn = RunService.Heartbeat:Connect(function()
                if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
                    conn:Disconnect() return
                end
                local hrp = plr.Character.HumanoidRootPart
                local time = tick() * rotationSpeed
                for i = 1, numParts do
                    local angle = time + (i * (2*math.pi/numParts))
                    local pos = Vector3.new(
                        hrp.Position.X + radius*math.cos(angle),
                        hrp.Position.Y+2,
                        hrp.Position.Z + radius*math.sin(angle)
                    )
                    for _, other in pairs(Players:GetPlayers()) do
                        if other ~= plr and other.Character then
                            local hum = other.Character:FindFirstChild("Humanoid")
                            local ohrp = other.Character:FindFirstChild("HumanoidRootPart")
                            if hum and ohrp and (ohrp.Position - pos).Magnitude < checkRadius then
                                hum.Health = 0
                            end
                        end
                    end
                end
            end)
            plr:SetAttribute("OrbitConn", conn)
        else
            local conn = plr:GetAttribute("OrbitConn")
            if conn then conn:Disconnect() plr:SetAttribute("OrbitConn", nil) end
        end
    elseif shieldType == "back" then
        -- Damage b·∫±ng l√° ch·∫Øn sau l∆∞ng
        if state then
            local conn
            conn = RunService.Heartbeat:Connect(function()
                if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
                    conn:Disconnect() return
                end
                local hrp = plr.Character.HumanoidRootPart
                local shieldPos = (hrp.CFrame * CFrame.new(0,0,-4)).Position
                for _, other in pairs(Players:GetPlayers()) do
                    if other ~= plr and other.Character then
                        local hum = other.Character:FindFirstChild("Humanoid")
                        local ohrp = other.Character:FindFirstChild("HumanoidRootPart")
                        if hum and ohrp and (ohrp.Position - shieldPos).Magnitude < 4 then
                            hum.Health = 0
                        end
                    end
                end
            end)
            plr:SetAttribute("BackConn", conn)
        else
            local conn = plr:GetAttribute("BackConn")
            if conn then conn:Disconnect() plr:SetAttribute("BackConn", nil) end
        end
    end
end)
