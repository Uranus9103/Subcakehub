-- GỌP CHO DỄ: Shield Client+Server

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- Tạo RemoteEvent nếu chưa có
local remote = ReplicatedStorage:FindFirstChild("ShieldToggleEvent")
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = "ShieldToggleEvent"
    remote.Parent = ReplicatedStorage
end

-- SETTINGS
local numParts = 6
local radius = 5
local rotationSpeed = 2
local checkRadius = 4
local damagePerHit = 25

-- TRANG THÁI
local active = false
local orbitParts = {}

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0,150,0,50)
button.Position = UDim2.new(0.5,-75,0.9,0)
button.Text = "Bật Lá Chắn"
button.Parent = screenGui

-- HÀM TẠO PART
local function createParts()
    local parts = {}
    for i = 1, numParts do
        local part = Instance.new("Part")
        part.Size = Vector3.new(2,2,2)
        part.Shape = Enum.PartType.Ball
        part.Anchored = true
        part.CanCollide = false
        part.Material = Enum.Material.Neon
        part.BrickColor = BrickColor.Random()
        part.Parent = workspace
        table.insert(parts, part)
    end
    return parts
end

-- Bật/Tắt shield
button.MouseButton1Click:Connect(function()
    active = not active
    button.Text = active and "Tắt Lá Chắn" or "Bật Lá Chắn"

    -- Gửi lệnh server
    remote:FireServer(active)
    
    -- Client tạo part hiển thị
    if active then
        orbitParts = createParts()
    else
        for _, p in pairs(orbitParts) do
            p:Destroy()
        end
        orbitParts = {}
    end
end)

-- CẬP NHẬT PART QUAY (CLIENT chỉ hiển thị cho bạn)
RunService.RenderStepped:Connect(function()
    if not active then return end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local time = tick() * rotationSpeed
    for i, part in ipairs(orbitParts) do
        local angle = time + (i * (2*math.pi/numParts))
        local x = hrp.Position.X + radius * math.cos(angle)
        local z = hrp.Position.Z + radius * math.sin(angle)
        part.Position = Vector3.new(x, hrp.Position.Y + 2, z)
    end
end)

-- SERVER SIDE: quản lý gây damage và chết thật
remote.OnServerEvent:Connect(function(plr, state)
    if state then
        -- bật shield server-side cho người chơi này
        if not plr.Character then return end
        local char = plr.Character
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        -- RunService server loop
        local connection
        connection = RunService.Heartbeat:Connect(function()
            if not plr or not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
                connection:Disconnect()
                return
            end
            local hrp = plr.Character.HumanoidRootPart
            local time = tick() * rotationSpeed

            for i = 1, numParts do
                local angle = time + (i * (2*math.pi/numParts))
                local x = hrp.Position.X + radius * math.cos(angle)
                local z = hrp.Position.Z + radius * math.sin(angle)
                local partPos = Vector3.new(x, hrp.Position.Y + 2, z)

                -- Kiểm tra người chơi khác
                for _, other in pairs(Players:GetPlayers()) do
                    if other ~= plr and other.Character then
                        local otherHum = other.Character:FindFirstChild("Humanoid")
                        local otherHRP = other.Character:FindFirstChild("HumanoidRootPart")
                        if otherHum and otherHRP then
                            if (otherHRP.Position - partPos).Magnitude < checkRadius then
                                otherHum.Health = 0 -- chết thật
                            end
                        end
                    end
                end
            end
        end)

        -- lưu connection để có thể tắt shield sau
        plr:SetAttribute("ShieldConnection", connection)
    else
        -- tắt shield
        local conn = plr:GetAttribute("ShieldConnection")
        if conn then
            conn:Disconnect()
            plr:SetAttribute("ShieldConnection", nil)
        end
    end
end)
