--// SHIELD CLIENT+SERVER + MUSIC

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

-- Tạo RemoteEvent nếu chưa có
local remote = ReplicatedStorage:FindFirstChild("ShieldToggleEvent")
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = "ShieldToggleEvent"
    remote.Parent = ReplicatedStorage
end

-- SETTINGS
local numParts = 6
local radius = 5
local rotationSpeed = 2
local checkRadius = 4

-- TRANG THÁI
local active = false
local orbitParts = {}
local currentMusic

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0,150,0,50)
button.Position = UDim2.new(1,-160,0,10) -- góc trên bên phải
button.Text = "Bật Lá Chắn"
button.Parent = screenGui

-- HÀM TẠO PART
local function createParts()
    local parts = {}
    for i = 1, numParts do
        local part = Instance.new("Part")
        part.Size = Vector3.new(2,2,2)
        part.Shape = Enum.PartType.Ball
        part.Anchored = true
        part.CanCollide = false
        part.Material = Enum.Material.Neon
        part.BrickColor = BrickColor.Random()
        part.Parent = Workspace
        table.insert(parts, part)
    end
    return parts
end

-- XÓA NHẠC GỐC
for _, obj in pairs(Workspace:GetChildren()) do
    if obj:IsA("Sound") then
        obj:Destroy()
    end
end

-- Bật/Tắt shield + nhạc
button.MouseButton1Click:Connect(function()
    active = not active
    button.Text = active and "Tắt Lá Chắn" or "Bật Lá Chắn"

    -- Client tạo part
    if active then
        orbitParts = createParts()
        -- Phát nhạc
        currentMusic = Instance.new("Sound")
        currentMusic.SoundId = "rbxassetid://131469953591233"
        currentMusic.Looped = true
        currentMusic.Parent = Workspace
        currentMusic:Play()
    else
        for _, p in pairs(orbitParts) do
            p:Destroy()
        end
        orbitParts = {}
        -- Dừng nhạc
        if currentMusic then
            currentMusic:Stop()
            currentMusic:Destroy()
            currentMusic = nil
        end
    end

    -- Gửi lệnh server
    remote:FireServer(active)
end)

-- CẬP NHẬT PART QUAY (CLIENT)
RunService.RenderStepped:Connect(function()
    if not active then return end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local time = tick() * rotationSpeed
    for i, part in ipairs(orbitParts) do
        local angle = time + (i * (2*math.pi/numParts))
        local x = hrp.Position.X + radius * math.cos(angle)
        local z = hrp.Position.Z + radius * math.sin(angle)
        part.Position = Vector3.new(x, hrp.Position.Y + 2, z)
    end
end)

-- SERVER SIDE: gây damage cho người khác
remote.OnServerEvent:Connect(function(plr, state)
    if state then
        if not plr.Character then return end
        local char = plr.Character
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        local connection
        connection = RunService.Heartbeat:Connect(function()
            if not plr or not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
                connection:Disconnect()
                return
            end
            local hrp = plr.Character.HumanoidRootPart
            local time = tick() * rotationSpeed
            for i = 1, numParts do
                local angle = time + (i * (2*math.pi/numParts))
                local x = hrp.Position.X + radius * math.cos(angle)
                local z = hrp.Position.Z + radius * math.sin(angle)
                local partPos = Vector3.new(x, hrp.Position.Y + 2, z)

                for _, other in pairs(Players:GetPlayers()) do
                    if other ~= plr and other.Character then
                        local otherHum = other.Character:FindFirstChild("Humanoid")
                        local otherHRP = other.Character:FindFirstChild("HumanoidRootPart")
                        if otherHum and otherHRP then
                            if (otherHRP.Position - partPos).Magnitude < checkRadius then
                                otherHum.Health = 0
                            end
                        end
                    end
                end
            end
        end)
        plr:SetAttribute("ShieldConnection", connection)
    else
        local conn = plr:GetAttribute("ShieldConnection")
        if conn then
            conn:Disconnect()
            plr:SetAttribute("ShieldConnection", nil)
        end
    end
end)
