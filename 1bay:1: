--// FULL SCRIPT: Shield + Music + Aura + Fire
-- Đặt vào StarterPlayer > StarterPlayerScripts (LocalScript)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer

-- RemoteEvent cho Shield
local remote = ReplicatedStorage:FindFirstChild("ShieldToggleEvent")
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = "ShieldToggleEvent"
    remote.Parent = ReplicatedStorage
end

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PowerMenu"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 250)
frame.Position = UDim2.new(1, -210, 0, 20) -- góc phải trên
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BackgroundTransparency = 0.3
frame.Parent = screenGui

-- Tạo nút helper
local function createButton(name, text, y)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -20, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, y)
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
    btn.Parent = frame
    btn.Name = name
    return btn
end

------------------------------------------------------
-- 1. Shield
------------------------------------------------------
local shieldBtn = createButton("ShieldBtn", "Bật Lá Chắn", 10)
local numParts, radius, rotationSpeed, checkRadius, damagePerHit = 6, 5, 2, 4, 25
local activeShield = false
local orbitParts = {}

-- tạo shield part
local function createParts()
    local parts = {}
    for i = 1, numParts do
        local part = Instance.new("Part")
        part.Size = Vector3.new(1.5,1.5,1.5)
        part.Shape = Enum.PartType.Ball
        part.Anchored = true
        part.CanCollide = false
        part.Material = Enum.Material.Neon
        part.Color = Color3.fromRGB(255, 170, 0)
        part.Parent = workspace
        table.insert(parts, part)
    end
    return parts
end

shieldBtn.MouseButton1Click:Connect(function()
    activeShield = not activeShield
    shieldBtn.Text = activeShield and "Tắt Lá Chắn" or "Bật Lá Chắn"
    remote:FireServer(activeShield)
    if activeShield then
        orbitParts = createParts()
    else
        for _, p in pairs(orbitParts) do p:Destroy() end
        orbitParts = {}
    end
end)

RunService.RenderStepped:Connect(function()
    if not activeShield then return end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local time = tick() * rotationSpeed
    for i, part in ipairs(orbitParts) do
        local angle = time + (i * (2*math.pi/numParts))
        local x = hrp.Position.X + radius * math.cos(angle)
        local z = hrp.Position.Z + radius * math.sin(angle)
        part.Position = Vector3.new(x, hrp.Position.Y + 2, z)
    end
end)

------------------------------------------------------
-- 2. Music Player
------------------------------------------------------
local musicBox = Instance.new("TextBox")
musicBox.Size = UDim2.new(1, -20, 0, 30)
musicBox.Position = UDim2.new(0, 10, 0, 60)
musicBox.PlaceholderText = "Nhập ID nhạc..."
musicBox.Text = ""
musicBox.BackgroundColor3 = Color3.fromRGB(80,80,80)
musicBox.TextColor3 = Color3.new(1,1,1)
musicBox.Parent = frame

local musicBtn = createButton("MusicBtn", "Phát Nhạc", 100)

local currentSound
musicBtn.MouseButton1Click:Connect(function()
    local id = tonumber(musicBox.Text)
    if not id then return end
    if currentSound then currentSound:Destroy() end
    -- tắt nhạc gốc game
    for _, s in pairs(SoundService:GetDescendants()) do
        if s:IsA("Sound") then s.Playing = false end
    end
    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://"..id
    sound.Looped = true
    sound.Volume = 2
    sound.Parent = SoundService
    sound:Play()
    currentSound = sound
end)

------------------------------------------------------
-- 3. Aura Donut
------------------------------------------------------
local auraBtn = createButton("AuraBtn", "Bật Hào Quang", 150)
local auraActive = false
local auraPart

auraBtn.MouseButton1Click:Connect(function()
    auraActive = not auraActive
    auraBtn.Text = auraActive and "Tắt Hào Quang" or "Bật Hào Quang"

    if auraActive then
        local char = player.Character or player.CharacterAdded:Wait()
        local hrp = char:WaitForChild("HumanoidRootPart")
        auraPart = Instance.new("Part")
        auraPart.Size = Vector3.new(6,1,6)
        auraPart.Anchored = false
        auraPart.CanCollide = false
        auraPart.Transparency = 0.3
        auraPart.Material = Enum.Material.Neon
        auraPart.Color = Color3.fromRGB(255, 223, 0)
        auraPart.Parent = hrp

        local weld = Instance.new("WeldConstraint")
        weld.Part0 = hrp
        weld.Part1 = auraPart
        weld.Parent = auraPart
        auraPart.CFrame = hrp.CFrame * CFrame.new(0,0,-3)

        local mesh = Instance.new("SpecialMesh")
        mesh.MeshType = Enum.MeshType.Torus
        mesh.Scale = Vector3.new(5,1,5)
        mesh.Parent = auraPart

        RunService.RenderStepped:Connect(function()
            if auraPart and auraPart.Parent then
                auraPart.CFrame = hrp.CFrame * CFrame.new(0,0,-3) * CFrame.Angles(0, tick()*2, 0)
            end
        end)
    else
        if auraPart then auraPart:Destroy() auraPart=nil end
    end
end)

------------------------------------------------------
-- 4. Fire Effect
------------------------------------------------------
local fireBtn = createButton("FireBtn", "Bật Lửa 🔥", 200)
local fireActive = false
local fire

fireBtn.MouseButton1Click:Connect(function()
    fireActive = not fireActive
    fireBtn.Text = fireActive and "Tắt Lửa 🔥" or "Bật Lửa 🔥"
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    if fireActive then
        fire = Instance.new("Fire")
        fire.Heat = 25
        fire.Size = 15
        fire.Parent = hrp
    else
        if fire then fire:Destroy() fire=nil end
    end
end)

------------------------------------------------------
-- SERVER DAMAGE SHIELD
------------------------------------------------------
remote.OnServerEvent:Connect(function(plr, state)
    if state then
        if not plr.Character then return end
        local connection
        connection = RunService.Heartbeat:Connect(function()
            if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
                connection:Disconnect() return
            end
            local hrp = plr.Character.HumanoidRootPart
            local time = tick() * rotationSpeed
            for i = 1, numParts do
                local angle = time + (i * (2*math.pi/numParts))
                local pos = Vector3.new(
                    hrp.Position.X + radius*math.cos(angle),
                    hrp.Position.Y+2,
                    hrp.Position.Z + radius*math.sin(angle)
                )
                for _, other in pairs(Players:GetPlayers()) do
                    if other ~= plr and other.Character then
                        local hum = other.Character:FindFirstChild("Humanoid")
                        local ohrp = other.Character:FindFirstChild("HumanoidRootPart")
                        if hum and ohrp then
                            if (ohrp.Position - pos).Magnitude < checkRadius then
                                hum.Health = 0
                            end
                        end
                    end
                end
            end
        end)
        plr:SetAttribute("ShieldConn", connection)
    else
        local conn = plr:GetAttribute("ShieldConn")
        if conn then conn:Disconnect() plr:SetAttribute("ShieldConn", nil) end
    end
end)
