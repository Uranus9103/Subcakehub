--// SHIELD MŨI TÊN VỚI DAMAGE

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- Tạo RemoteEvent nếu chưa có
local remote = ReplicatedStorage:FindFirstChild("ArrowShieldEvent")
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = "ArrowShieldEvent"
    remote.Parent = ReplicatedStorage
end

-- SETTINGS
local numArrows = 6
local radius = 5
local rotationSpeed = 2
local checkRadius = 4
local damagePerHit = 25

-- TRANG THÁI
local active = false
local arrows = {}

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0,150,0,50)
button.Position = UDim2.new(0.5,-75,0.9,0)
button.Text = "Bật Shield Mũi Tên"
button.Parent = screenGui

-- HÀM TẠO MŨI TÊN
local function createArrow()
    local part = Instance.new("Part")
    part.Size = Vector3.new(1,1,4)
    part.Anchored = true
    part.CanCollide = false
    part.Material = Enum.Material.Neon
    part.BrickColor = BrickColor.Random()

    -- Tạo trail
    local trail = Instance.new("Trail")
    trail.Attachment0 = Instance.new("Attachment", part)
    trail.Attachment1 = Instance.new("Attachment", part)
    trail.Lifetime = 0.3
    trail.Color = ColorSequence.new(part.Color)
    trail.Parent = part

    part.Parent = workspace
    return part
end

-- Bật/Tắt shield
button.MouseButton1Click:Connect(function()
    active = not active
    button.Text = active and "Tắt Shield Mũi Tên" or "Bật Shield Mũi Tên"
    remote:FireServer(active)

    -- Client tạo visual mũi tên
    if active then
        for i = 1, numArrows do
            table.insert(arrows, createArrow())
        end
    else
        for _, a in pairs(arrows) do
            a:Destroy()
        end
        arrows = {}
    end
end)

-- Client update mũi tên quay quanh
RunService.RenderStepped:Connect(function()
    if not active then return end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local time = tick() * rotationSpeed
    for i, arrow in ipairs(arrows) do
        local angle = time + (i * (2*math.pi/numArrows))
        local x = hrp.Position.X + radius * math.cos(angle)
        local z = hrp.Position.Z + radius * math.sin(angle)
        arrow.Position = Vector3.new(x, hrp.Position.Y + 2, z)
        arrow.CFrame = CFrame.lookAt(arrow.Position, hrp.Position)
    end
end)

-- SERVER SIDE: damage người khác
remote.OnServerEvent:Connect(function(plr, state)
    if state then
        if not plr.Character then return end
        local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        local connection
        connection = RunService.Heartbeat:Connect(function()
            if not plr or not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
                connection:Disconnect()
                return
            end
            local hrp = plr.Character.HumanoidRootPart
            local time = tick() * rotationSpeed

            for i = 1, numArrows do
                local angle = time + (i * (2*math.pi/numArrows))
                local x = hrp.Position.X + radius * math.cos(angle)
                local z = hrp.Position.Z + radius * math.sin(angle)
                local pos = Vector3.new(x, hrp.Position.Y + 2, z)

                for _, other in pairs(Players:GetPlayers()) do
                    if other ~= plr and other.Character then
                        local hum = other.Character:FindFirstChild("Humanoid")
                        local oHRP = other.Character:FindFirstChild("HumanoidRootPart")
                        if hum and oHRP then
                            if (oHRP.Position - pos).Magnitude < checkRadius then
                                hum:TakeDamage(damagePerHit)
                            end
                        end
                    end
                end
            end
        end)
        plr:SetAttribute("ArrowShieldConnection", connection)
    else
        local conn = plr:GetAttribute("ArrowShieldConnection")
        if conn then
            conn:Disconnect()
            plr:SetAttribute("ArrowShieldConnection", nil)
        end
    end
end)
