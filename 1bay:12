--// FULL MENU: Shield + Music + Halo + Fire
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- RemoteEvent ƒë·ªÉ b·∫≠t shield
local remote = ReplicatedStorage:FindFirstChild("ShieldToggleEvent")
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = "ShieldToggleEvent"
    remote.Parent = ReplicatedStorage
end

-- SETTINGS
local numParts = 6
local radius = 5
local rotationSpeed = 2
local checkRadius = 4

-- Tr·∫°ng th√°i
local shieldActive = false
local orbitParts = {}
local haloActive = false
local halo = nil
local fireActive = false
local fireEffect = nil
local musicSound = nil

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PowerMenu"
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Khung menu
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0,220,0,280)
frame.Position = UDim2.new(1,-230,0,20)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
frame.BackgroundTransparency = 0.2
frame.BorderSizePixel = 0
frame.Parent = screenGui

-- UICorner bo tr√≤n
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0,10)
corner.Parent = frame

-- UIList ƒë·ªÉ s·∫Øp x·∫øp n√∫t d·ªçc
local layout = Instance.new("UIListLayout")
layout.Parent = frame
layout.Padding = UDim.new(0,8)
layout.FillDirection = Enum.FillDirection.Vertical
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.VerticalAlignment = Enum.VerticalAlignment.Top

-- H√†m t·∫°o n√∫t
local function createButton(text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,200,0,40)
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.TextSize = 18
    btn.Text = text
    btn.Parent = frame
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0,8)
    c.Parent = btn
    return btn
end

-- N√∫t L√° Ch·∫Øn
local shieldBtn = createButton("üõ° B·∫≠t L√° Ch·∫Øn")

-- √î nh·∫≠p nh·∫°c
local musicBox = Instance.new("TextBox")
musicBox.Size = UDim2.new(0,200,0,35)
musicBox.PlaceholderText = "Nh·∫≠p ID nh·∫°c..."
musicBox.Text = ""
musicBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
musicBox.TextColor3 = Color3.new(1,1,1)
musicBox.TextSize = 16
musicBox.Parent = frame
local c1 = Instance.new("UICorner")
c1.CornerRadius = UDim.new(0,8)
c1.Parent = musicBox

-- N√∫t ph√°t nh·∫°c
local musicBtn = createButton("üéµ Ph√°t Nh·∫°c")

-- N√∫t H√†o Quang
local haloBtn = createButton("‚ú® B·∫≠t H√†o Quang")

-- N√∫t L·ª≠a
local fireBtn = createButton("üî• B·∫≠t L·ª≠a")

-------------------------------------------------
-- FUNCTIONS
-------------------------------------------------

-- T·∫°o part shield
local function createShieldParts()
    local parts = {}
    for i = 1, numParts do
        local part = Instance.new("Part")
        part.Size = Vector3.new(2,2,2)
        part.Shape = Enum.PartType.Ball
        part.Anchored = true
        part.CanCollide = false
        part.Material = Enum.Material.Neon
        part.Color = Color3.fromRGB(255,0,0)
        part.Transparency = 0.2
        part.Parent = workspace
        table.insert(parts, part)
    end
    return parts
end

-- Shield button
shieldBtn.MouseButton1Click:Connect(function()
    shieldActive = not shieldActive
    shieldBtn.Text = shieldActive and "üõ° T·∫Øt L√° Ch·∫Øn" or "üõ° B·∫≠t L√° Ch·∫Øn"
    remote:FireServer(shieldActive)

    if shieldActive then
        orbitParts = createShieldParts()
    else
        for _, p in ipairs(orbitParts) do
            p:Destroy()
        end
        orbitParts = {}
    end
end)

-- Music button
musicBtn.MouseButton1Click:Connect(function()
    if musicSound then
        musicSound:Destroy()
        musicSound = nil
        musicBtn.Text = "üéµ Ph√°t Nh·∫°c"
        return
    end

    local id = tonumber(musicBox.Text)
    if id then
        -- T·∫Øt nh·∫°c g·ªëc
        for _, s in ipairs(workspace:GetDescendants()) do
            if s:IsA("Sound") and s.Playing then
                s.Playing = false
            end
        end
        -- Ph√°t nh·∫°c m·ªõi
        musicSound = Instance.new("Sound")
        musicSound.SoundId = "rbxassetid://"..id
        musicSound.Looped = true
        musicSound.Volume = 5
        musicSound.Parent = workspace
        musicSound:Play()
        musicBtn.Text = "‚èπ D·ª´ng Nh·∫°c"
    end
end)

-- Halo button
haloBtn.MouseButton1Click:Connect(function()
    haloActive = not haloActive
    haloBtn.Text = haloActive and "‚ú® T·∫Øt H√†o Quang" or "‚ú® B·∫≠t H√†o Quang"

    if haloActive then
        halo = Instance.new("Part")
        halo.Size = Vector3.new(6,0.5,6)
        halo.Anchored = true
        halo.CanCollide = false
        halo.Material = Enum.Material.Neon
        halo.Color = Color3.fromRGB(255,223,0)
        halo.Shape = Enum.PartType.Cylinder
        halo.Transparency = 0.3
        halo.Parent = workspace
    else
        if halo then
            halo:Destroy()
            halo = nil
        end
    end
end)

-- Fire button
fireBtn.MouseButton1Click:Connect(function()
    fireActive = not fireActive
    fireBtn.Text = fireActive and "üî• T·∫Øt L·ª≠a" or "üî• B·∫≠t L·ª≠a"

    if fireActive then
        if player.Character then
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                fireEffect = Instance.new("Fire")
                fireEffect.Size = 8
                fireEffect.Heat = 20
                fireEffect.Color = Color3.fromRGB(255,100,0)
                fireEffect.SecondaryColor = Color3.fromRGB(255,200,50)
                fireEffect.Parent = hrp
            end
        end
    else
        if fireEffect then
            fireEffect:Destroy()
            fireEffect = nil
        end
    end
end)

-------------------------------------------------
-- RenderStepped Update
-------------------------------------------------
RunService.RenderStepped:Connect(function()
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local t = tick() * rotationSpeed

    -- Update shield
    if shieldActive then
        for i, part in ipairs(orbitParts) do
            local angle = t + (i * (2*math.pi/numParts))
            local x = hrp.Position.X + radius * math.cos(angle)
            local z = hrp.Position.Z + radius * math.sin(angle)
            part.Position = Vector3.new(x, hrp.Position.Y + 2, z)
        end
    end

    -- Update halo
    if haloActive and halo then
        halo.CFrame = hrp.CFrame * CFrame.new(0,2,3) * CFrame.Angles(0, tick()*2, 0)
    end
end)

-------------------------------------------------
-- Server Side: Shield Damage
-------------------------------------------------
remote.OnServerEvent:Connect(function(plr, state)
    if state then
        local connection
        connection = RunService.Heartbeat:Connect(function()
            if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
                connection:Disconnect()
                return
            end
            local hrp = plr.Character.HumanoidRootPart
            local time = tick() * rotationSpeed

            for i = 1, numParts do
                local angle = time + (i * (2*math.pi/numParts))
                local x = hrp.Position.X + radius * math.cos(angle)
                local z = hrp.Position.Z + radius * math.sin(angle)
                local partPos = Vector3.new(x, hrp.Position.Y + 2, z)

                for _, other in pairs(Players:GetPlayers()) do
                    if other ~= plr and other.Character then
                        local otherHum = other.Character:FindFirstChild("Humanoid")
                        local otherHRP = other.Character:FindFirstChild("HumanoidRootPart")
                        if otherHum and otherHRP then
                            if (otherHRP.Position - partPos).Magnitude < checkRadius then
                                otherHum.Health = 0 -- ch·∫øt th·∫≠t
                            end
                        end
                    end
                end
            end
        end)
        plr:SetAttribute("ShieldConnection", connection)
    else
        local conn = plr:GetAttribute("ShieldConnection")
        if conn then
            conn:Disconnect()
            plr:SetAttribute("ShieldConnection", nil)
        end
    end
end)
