local Players = game:GetService("Players")
local MAX_TIME = 120  
local plots = workspace.Plots:GetChildren()
local playerPlots = {}

----------------------------------------------------------------
-- HÀM GÁN PLOT VÀ CHẠY ĐỒNG HỒ
----------------------------------------------------------------
local function assignPlot(player)
	for _, plot in ipairs(plots) do
		if not playerPlots[plot] then
			playerPlots[plot] = player
			return plot
		end
	end
	return nil
end

local function startCountdown(plot, player)
	local label = plot.Purchases.PlotBlock.Main.BillboardGui:FindFirstChild("Remaining Time")
	if not label then return end
	
	local timeLeft = MAX_TIME
	label.Text = "Thời gian của " .. player.Name .. ": " .. timeLeft .. "s"
	
	while timeLeft > 0 and player.Parent == Players do
		wait(1)
		timeLeft -= 1
		label.Text = "Thời gian của " .. player.Name .. ": " .. timeLeft .. "s"
	end
	
	label.Text = "Hết thời gian cho " .. player.Name .. "!"
end

----------------------------------------------------------------
-- XỬ LÝ PLAYER JOIN/LEAVE
----------------------------------------------------------------
Players.PlayerAdded:Connect(function(player)
	local plot = assignPlot(player)
	if plot then
		task.spawn(function()
			startCountdown(plot, player)
		end)
	end

	-- Tạo nút ESP cho player
	player.CharacterAdded:Connect(function()
		task.wait(1)
		local screenGui = Instance.new("ScreenGui")
		screenGui.Name = "ESPGui"
		screenGui.ResetOnSpawn = false
		screenGui.Parent = player:WaitForChild("PlayerGui")

		local button = Instance.new("TextButton")
		button.Size = UDim2.new(0, 120, 0, 40)
		button.Position = UDim2.new(0.85, 0, 0.9, 0) -- góc phải dưới
		button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
		button.TextColor3 = Color3.fromRGB(255, 255, 255)
		button.Text = "Bật ESP"
		button.Parent = screenGui

		local espOn = false

		local function toggleESP()
			espOn = not espOn
			if espOn then
				button.Text = "Tắt ESP"
				-- bật BillboardGui
				for _, plot in ipairs(workspace.Plots:GetChildren()) do
					local gui = plot:FindFirstChild("Purchases") and plot.Purchases.PlotBlock.Main:FindFirstChild("BillboardGui")
					if gui then
						gui.Enabled = true
					end
				end
			else
				button.Text = "Bật ESP"
				-- tắt BillboardGui
				for _, plot in ipairs(workspace.Plots:GetChildren()) do
					local gui = plot:FindFirstChild("Purchases") and plot.Purchases.PlotBlock.Main:FindFirstChild("BillboardGui")
					if gui then
						gui.Enabled = false
					end
				end
			end
		end

		button.MouseButton1Click:Connect(toggleESP)

		-- Mặc định ESP tắt
		for _, plot in ipairs(workspace.Plots:GetChildren()) do
			local gui = plot:FindFirstChild("Purchases") and plot.Purchases.PlotBlock.Main:FindFirstChild("BillboardGui")
			if gui then
				gui.Enabled = false
			end
		end
	end)
end)

Players.PlayerRemoving:Connect(function(player)
	for plot, owner in pairs(playerPlots) do
		if owner == player then
			playerPlots[plot] = nil
			local label = plot.Purchases.PlotBlock.Main.BillboardGui:FindFirstChild("Remaining Time")
			if label then
				label.Text = "Chưa có chủ"
			end
		end
	end
end)
